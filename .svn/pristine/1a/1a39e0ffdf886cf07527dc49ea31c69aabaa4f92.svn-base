package kr.or.dduk.ams.controller;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import kr.or.dduk.ams.service.HospitalReceptionService;
import kr.or.dduk.common.service.CommonService;
import kr.or.dduk.employee.service.EmployeeService;
import kr.or.dduk.util.SessionInfo;
import kr.or.dduk.vo.EmployeeVO;
import kr.or.dduk.vo.HospitalReceptionVO;
import kr.or.dduk.vo.PatientVO;
import kr.or.dduk.vo.ProofApplicationVO;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@RequestMapping("/ams")
@Controller
public class HospitalReceptionController {

	@Autowired
	HospitalReceptionService hospitalReceptionService;
	
	// 환자 리스트를 위해 쓰는 커먼서비스
	@Autowired
	CommonService commonService;
	
	// 의사 리스트를 가저오는 서비스
	@Autowired
	EmployeeService employeeService;
	
	// 현재 접속한 사람의 사번을 가져오기 위해
	@Autowired
	SessionInfo sessionInfo;
	
	/**
	 * 접수 페이지
	 * @param model 환자 리스트
	 * @return reception.jsp
	 */
	@GetMapping("/reception")
	public String reception(Model model) {
		//모든 접수 내역 가져오기
		List<HospitalReceptionVO> hospitalReceptionVOList = this.hospitalReceptionService.getAllReceptionList();

		//의사 리스트 가져오기
		List<EmployeeVO> doctorVOList = this.employeeService.getDoctorList();
		
		//접수 내역 나누기
		List<HospitalReceptionVO> waitingVOList = new ArrayList<HospitalReceptionVO>();
		List<HospitalReceptionVO> completeVOList = new ArrayList<HospitalReceptionVO>();
		
		//진료상태가 대기중(null)이거나 진료완료(CRST04)가 아닌 환자 리스트를 만들기
		for(HospitalReceptionVO hospitalReceptionVO : hospitalReceptionVOList) {
			if(hospitalReceptionVO.getClinicState()== null || !hospitalReceptionVO.getClinicState().equals("CRST04")) {
				waitingVOList.add(hospitalReceptionVO);
			}
		}
		
		//진료상태가 대기중(null)이 아니고 진료완료(CRST04)인 환자 리스트를 만들기
		for(HospitalReceptionVO hospitalReceptionVO : hospitalReceptionVOList) {
			if(hospitalReceptionVO.getClinicState()!= null && hospitalReceptionVO.getClinicState().equals("CRST04")) {
				completeVOList.add(hospitalReceptionVO);
			}
		}
		
		//호출된 사람만 부르는 리스트
		List<HospitalReceptionVO> docOfcList = new ArrayList<HospitalReceptionVO>();
		for(HospitalReceptionVO hospitalReceptionVO : hospitalReceptionVOList) {
			if(hospitalReceptionVO.getClinicState()== null || !hospitalReceptionVO.getClinicState().equals("CRST04")
				&& hospitalReceptionVO.getHsrpState().equals("RCST02")) {
				docOfcList.add(hospitalReceptionVO);
			}
		}
		System.out.println("확인이요~!" + docOfcList);
		
		//모델에 데이터 저장
		model.addAttribute("waitingVOList",waitingVOList);
		model.addAttribute("completeVOList",completeVOList);
		model.addAttribute("docOfcList",docOfcList);
		
		model.addAttribute("doctorVOList",doctorVOList);
		
		return "ams/reception";
	}
	
	
	/**
	 * 비동기통신 방법으로 현재 담당의가 나인 진료대기환자 목록을 뽑아옴
	 */
	@ResponseBody
	@PostMapping("/getReceptionList")
	public List<HospitalReceptionVO> getReceptionList() {
		String empNo = sessionInfo.getEmpNo();
		List<HospitalReceptionVO> hospitalReceptionVOList = this.hospitalReceptionService.getReceptionList(empNo);
		return hospitalReceptionVOList;
	}
	
	/**
	 * 제증명 신청
	 * @param proofApplicationVO
	 * @return
	 */
	@ResponseBody
	@PostMapping("/createProofApplication")
	public ProofApplicationVO createProofApplication(@RequestBody ProofApplicationVO proofApplicationVO) {
		int result = this.hospitalReceptionService.createProofApplication(proofApplicationVO);
		return proofApplicationVO;
	}
	
	/**
	 * 비동기통신 방법으로 모든 환자 목록을 가져옴
	 */
	@ResponseBody
	@GetMapping("/getPatientList")
	public List<PatientVO> getPatientList() {
		List<PatientVO> patientVOList = this.commonService.list();
		return patientVOList;
	}
	
	/**
	 * 비동기통신 방법으로 주민등록번호과 일치하는 환자를 가져옴
	 */
	@ResponseBody
	@PostMapping("/searchPatientByReg")
	public PatientVO searchPatientByReg(@RequestBody String paReg) {
		PatientVO patientVO = this.commonService.searchPatientByReg(paReg);
		return patientVO;
	}
	
	/**
	 * 비동기통신 방법으로 주민등록번호과 일치하는 환자를 가져옴
	 */
	@ResponseBody
	@PostMapping("/addReception")
	public int addReception(@RequestBody HospitalReceptionVO hospitalReceptionVO) {
		int result = this.hospitalReceptionService.addReception(hospitalReceptionVO);
		log.info("hospitalReceptionVO : " + hospitalReceptionVO);
		return result;
	}
}
