<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.or.dduk.mapper.HospitalReceptionMapper">

	<select id="getReceptionList" resultType="hospitalReceptionVO">
		SELECT
			HR.HSRP_NO,
			HR.HSRP_DT,
			HR.HSRP_REASON,
			HR.PA_NO,
			HR.EMP_NO,
			HR.HSRP_TYPE,
			HR.HSRP_STATE,
			P.PA_NAME,
			P.PA_REG,
            C.CLINIC_STATE
		FROM
			HOSPITAL_RECEPTION HR
		JOIN
			PATIENT P ON HR.PA_NO = P.PA_NO
        LEFT JOIN
            CLINIC_CHART C ON HR.HSRP_NO = C.HSRP_NO
		WHERE
			HR.EMP_NO = #{empNo}
            AND (C.CLINIC_STATE IS NULL OR C.CLINIC_STATE != 'CRST04')
		ORDER BY
			CASE WHEN HR.HSRP_TYPE = 'RCTY02' THEN 0 ELSE 1 END,
			HR.HSRP_NO ASC
	</select>
	
	<select id="getAllReceptionList" resultType="hospitalReceptionVO">
		SELECT
			HR.HSRP_NO,
			HR.HSRP_DT,
			HR.HSRP_REASON,
			HR.PA_NO,
			HR.EMP_NO,
			HR.HSRP_TYPE,
			HR.HSRP_STATE,
			P.PA_NAME,
			P.PA_REG,
            C.CLINIC_STATE
		FROM
			HOSPITAL_RECEPTION HR
		JOIN
			PATIENT P ON HR.PA_NO = P.PA_NO
        LEFT JOIN
            CLINIC_CHART C ON HR.HSRP_NO = C.HSRP_NO
<!-- 		WHERE -->
<!-- 			(C.CLINIC_STATE IS NULL OR C.CLINIC_STATE != 'CRST04') -->
		ORDER BY
			CASE WHEN HR.HSRP_TYPE = 'RCTY02' THEN 0 ELSE 1 END,
			HR.HSRP_NO ASC
	</select>
	
	<insert id="createProofApplication" parameterType="proofApplicationVO">
		<selectKey>
			SELECT 'PRAP' || TRIM(TO_CHAR(SUBSTR(MAX(PRAP_NO),5)+1,'0000')) 
			AS PA_NO FROM PROOF_APPLICATION
		</selectKey>
		INSERT INTO PROOF_APPLICATION
			   (PRAP_NO, CLINIC_NO, PRDC_CD, PRAP_STATE)
		VALUES (#{prapNo}, #{clinicNo}, #{prdcCd}, 'PAST001')
	</insert>

	<insert id="addReception" parameterType="hospitalReceptionVO">
		<selectKey resultType="String" keyProperty="hsrpNo" order="BEFORE">
			SELECT 'RP' ||TRIM(TO_CHAR(SUBSTR(MAX(HSRP_NO),5)+1,'00000'))
			FROM HOSPITAL_RECEPTION
		</selectKey>
		INSERT INTO HOSPITAL_RECEPTION(HSRP_NO, HSRP_DT, HSRP_REASON, PA_NO, EMP_NO, HSRP_TYPE, HSRP_STATE)
		VALUES(#{hsrpNo}, SYSDATE, #{hsrpReason}, #{paNo}, #{empNo}, #{hsrpType}, 'RCST01')
	</insert>
</mapper>