<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<script src="/resources/js/jquery-3.6.0.js"></script>
<title>문자인증</title>
</head>

<style>
/* 어사이드 강조 */
.aside-ams-crm{
	width: 196px;
	border-radius: 16px 0px 0px 16px;
	background: var(--bg-02, #DBF2F4);
	height: 56px;
	border-right: 4px solid var(--ci-01, #0ABAB5);
	margin-left: 4px;
	color: var(--ci-01, #0ABAB5);
}

/* mms.jsp 전용 */
#all-patient, #has-reservation-patient{
	display: none;
}

.left, .right {
   width: 810px;
   box-sizing: border-box;
   height: 410px;
}

.container {
   display: flex;
}

.crm-wrap {
   display: flex;
   height: 357px;
   gap: 9px;
   margin-bottom: 52px;
}

#formDiv{
   margin-left : 30px;
}
.fmrBtn{
   float: left;
   margin: 2px;
}

img{
   width: 25px;
   height: 25px;
   margin-bottom: 5px;
   margin-left: 5px;
}
/* mms.jsp 전용 */
</style>

<body>
<div>
	<div class="crm-wrap">
		<div class="dduk-body-border left">
			<div class="container">
            <h2>
            <select id="formSlct">
               <option>양식 선택</option>
                  <c:forEach var="mmsFormVO" items="${mmsFormVOList}">
                     <option 
                        data-json='{"cont": "${mmsFormVO.getMmsFormCont()}", "cd": "${mmsFormVO.getMmsFormCd()}" }'
                        >${mmsFormVO.getMmsFormNm()}
                        </option><br/>
                  </c:forEach>
             </select>문자 작성</h2>
          
			</div>
            <div class="container">
			<h3>양식제목 : <input class="dduck-input" type="text" id="formNm" name="formNm"/></h3>
				<div id="formDiv">
	                <button type="button" id="addForm" class="dduk-btn-active fmrBtn">양식  추가</button>
	                <button type="button" id="updateForm" class="dduk-btn-normal fmrBtn">양식  수정</button>
	                <button type="button" id="deleteForm" class="dduk-btn-danger fmrBtn">양식  삭제</button>
                 </div>
            </div>
         	<hr/>
            
			<div class="container">
            	<textarea class="dduck-input" rows="12" cols="100" id="textArea" name="textArea"></textarea>
         	</div>
		</div>
      
		<div class="dduk-body-border right">
			<div class="contents"> 
            <h2>문자 발송 내역</h2>
            <hr/>
				<div class="card-body table-responsive p-0" style="height: 250px;">
					<table class="table table-head-fixed text-nowrap">
						<thead>
							<tr>
								<th>발신 직원</th>
								<th>수신 고객</th>
								<th>날짜</th>
								<th>내용</th>
							</tr>
						</thead>
						<tbody>
						<c:forEach var="mmsHstrVO" items="${mmsHstrVOList}" varStatus="stat">
	                    	<tr>
		                        <td>${mmsHstrVO.mmsSent}</td>
		                        <td>${mmsHstrVO.mmsRecv}</td>
		                        <td><fmt:formatDate value="${mmsHstrVO.mmsDate}" pattern="yyyy-MM-dd" /></td>
		                        <td>${mmsHstrVO.mmsCont}</td>
	                    	</tr>
		                </c:forEach>
						</tbody>
					</table>
				</div>
         	</div>
      	</div>
	</div>
   
<br/>

   <div class="crm-wrap">
      <div class="dduk-body-border left">
         <div class="contents"> 
            <h2>
            <select id="patient-type">
               <option>분류</option>
               <option>전체</option>
               <option>예약</option>
               <option>입원</option>
            </select>
           	 환자 검색 : <input class="dduck-input" type="text"/>
			<button type="submit" class="btn btn-default">
				<i class="fas fa-search"></i>
			</button>
            </h2>
            
            <hr/>
            
            <table class="table table-head-fixed text-nowrap">
				<thead>
					<tr class="tr-padding">
						<th><input type="checkbox" id="check-all-patient"/> 전체</th>
						<th>이름</th>
						<th>예약날짜</th>
						<th>예약시간</th>
						<th>전화번호</th>
					</tr>
				</thead>
				
				<tbody id="all-patient">
				<c:forEach var="patient" items="${patientVOList}" varStatus="status">
					<tr class="tr-padding" data-paNo="${patient.paNo}">
						<td><input type="checkbox" class="all-patient-check"/></td>
						<td class="td-padding gray-text">${patient.paName}</td>
						<td class="td-padding gray-text"></td>
						<td class="td-padding gray-text"></td>
						<td class="td-padding gray-text">${patient.paPh}</td>
					</tr>
				</c:forEach>
				</tbody>
				
				<tbody id="has-reservation-patient">
				<c:forEach var="receptionVO" items="${receptionVOList}" varStatus="status">
					<tr class="tr-padding" data-paNo="${receptionVO.patientVO.paNo}">
<%-- 								<td class="td-padding gray-text">${status.count}</td> --%>
						<td><input type="checkbox" class="has-reservation-patient-check"/></td>
						<td class="td-padding gray-text">${receptionVO.patientVO.paName}</td>
						<td class="td-padding gray-text"><fmt:formatDate value="${receptionVO.rsvtDt}" pattern="MM월 dd일"/></td>
						<td class="td-padding gray-text"><fmt:formatDate value="${receptionVO.rsvtDt}" pattern="hh:mm"/></td>
						<td class="td-padding gray-text">${receptionVO.patientVO.paPh}</td>
					</tr>
				</c:forEach>
				</tbody>
				
			</table>
         </div>
      </div>
      
	<div class="dduk-body-border right">
		<div class="contents"> 
			<!-- 문자보내는 전송버튼 -->
			<h2> 발송 대상<img src="/resources/images/send.png"/><button type="button" class="dduk-btn-active" id="send" style="float: right;">발송</button></h2>
			
		</div>
         <hr/>
         <input type="text" id="to" name="to"/>
		<table class="table table-head-fixed text-nowrap">
			<thead>
				<tr class="tr-padding">
					<th><input type="checkbox" id="check-all-send"/> 전체</th>
					<th>이름</th>
					<th>예약날짜</th>
					<th>예약시간</th>
					<th>전화번호</th>
				</tr>
			</thead>
			<tbody id="send-patient-list">
			</tbody>
		</table>
      </div>
   </div>
</div>
</body>

<script type="text/javascript">
//function들에서 쓸 변수
var dataJson="";
var data="";
var cd="";

$(document).ready(function() {
	//접수 아이콘 강조
	$('.aside-ams-crm').find('svg').find('path').attr('fill', '#0ABAB5');
	
   $('#formSlct').change(formSlctChange);
   
   sendMMS();
   addForm();
   updateForm();
   deleteForm();
});

function formSlctChange(){
   //선택된 option에 들어있는 data-json 꺼내기
   dataJson = $('#formSlct option:selected').attr('data-json');
   data = JSON.parse(dataJson);
   
   //각 변수에 코드와 내용 할당
   cd = data.cd;
   cont = data.cont;
   
   $('#formNm').val($('#formSlct option:selected').val());
   $('#textArea').val(cont);
};

//셀렉트 변경될 때
$('#patient-type').change(function(){
	//선택된 옵션이 전체 일 때
	if($('#patient-type option:selected').val()=='전체'){
		$('#all-patient').show();
		$('#has-reservation-patient').hide();
	}
	if($('#patient-type option:selected').val()=='예약'){
		$('#all-patient').hide();
		$('#has-reservation-patient').show();
	}
});

//전체 체크되면 모두 체크되기
$('#check-all-patient').change(function(){
	if($(this).is(':checked')) {
		if($('#patient-type option:selected').val()=='전체'){
			$('.all-patient-check').prop('checked', true);
			$('#send-patient-list').append($('.all-patient-check').parent().parent());
			$('#check-all-patient').prop('checked', false);
		}
		if($('#patient-type option:selected').val()=='예약'){
			$('.has-reservation-patient-check').prop('checked', true);
			$('#send-patient-list').append($('.has-reservation-patient-check').parent().parent());
			$('#check-all-patient').prop('checked', false);
		}
	}
});

//전송 전체 체크하면 다시 되돌리는겨
$('#check-all-send').change(function(){
	if($(this).is(':checked')) {
		if($('#patient-type option:selected').val()=='전체'){
			$('.all-patient-check').prop('checked', false);
			$('#all-patient').append($('.all-patient-check').parent().parent());
			$('#check-all-send').prop('checked', false);
		}
		if($('#patient-type option:selected').val()=='예약'){
			$('.has-reservation-patient-check').prop('checked', false);
			$('#has-reservation-patient').append($('.has-reservation-patient-check').parent().parent());
			$('#check-all-send').prop('checked', false);
		}
	}
});

//전체 환자로 불러온 애들 왔다갔다 로직
$('.all-patient-check').change(function() {
       if ($(this).is(':checked')) {
    	   $('#send-patient-list').prepend($(this).closest('tr'));
       }else{
    	   $('#all-patient').prepend($(this).parent().parent());
       }
   });

//예약 환자로 불러온 애들 왔다갔다 로직
$('.has-reservation-patient-check').change(function() {
       if ($(this).is(':checked')) {
    	   $('#send-patient-list').prepend($(this).parent().parent());
       }else{
    	   $('#has-reservation-patient').prepend($(this).parent().parent());
       }
   });

//내역 추가
function addHstr(dataArray){
   var mmsHstrVOList = [];
   
   for(let i = 0; i < dataArray.length; i++){
	  var data = {
	   "mmsFormCd" : cd,
       "mmsSent" : empName,
       "mmsRecv" : dataArray[i].toName,
       "mmsCont" : dataArray[i].text
	  }
	  mmsHstrVOList.push(data);
	  console.log(data);
   }
   
   $.ajax ({
      url: '/crm/addHstr',
      type: 'POST',
      data: JSON.stringify(mmsHstrVOList),
//       dataType: "json",
      contentType:"application/json;charset=utf-8",
      beforeSend:function(xhr){
         xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
      },
      success: function(data) {
    	  Swal.fire({
              title: '발송 성공',
              icon: 'success',
              showCancelButton: false,
              confirmButtonColor: '#0ABAB5',
              cancelButtonColor: '#8D9EA5',
              confirmButtonText: '확인',
              cancelButtonText: '취소'
           }).then((result) => {
              // 확인버튼 클릭시
              if (result.isConfirmed) {
            	  window.location.href = '/crm/mms';
              }
           })
      },
       error: function(jqXHR, textStatus, errorThrown) {
    	   Swal.fire({
               title: '발송 실패',
               icon: 'error',
               showCancelButton: false,
               confirmButtonColor: '#0ABAB5',
               cancelButtonColor: '#8D9EA5',
               confirmButtonText: '확인',
               cancelButtonText: '취소'
    	   });
       	}
	});
};

//문자 보내기
function sendMMS(){
	$('#send').click(function() {
	  var dataArray = [];
	  var content = "";
	  
      for(let i = 0; i < $('#send-patient-list tr').length; i++){
    	  content = $('#textArea').val();
    	 
    	  //환자 이름 치환
    	  var replacedContent = content.replace("{환자명}",$('#send-patient-list tr').eq(i).children().eq(1).html());
    	  
    	  //월/일/시간 합치기
    	  var date = $('#send-patient-list tr').eq(i).children().eq(2).html() + " " + $('#send-patient-list tr').eq(i).children().eq(3).html() + '시';
    	  
    	  //예약 날짜 치환
    	  replacedContent = replacedContent.replace("{예약시간}",date);
    	  
    	  var obj = {
    			  "to" : $('#send-patient-list tr').eq(i).children().eq(4).html(),
    			  "text" : replacedContent,
    			  "toName" : $('#send-patient-list tr').eq(i).children().eq(1).html()
    	  }
    	  dataArray.push(obj);
      }
      
      $.ajax ({
         url: '/crm/sendMMS',
         type: 'POST',
         contentType:"application/json;charset=utf-8",
         data: JSON.stringify(dataArray),
         beforeSend:function(xhr){
             xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
          },
         success: function() {
        	 addHstr(dataArray);
         },
          error: function(jqXHR, textStatus, errorThrown) {
        	  Swal.fire({
                  title: '발송 실패',
                  icon: 'error',
                  showCancelButton: false,
                  confirmButtonColor: '#0ABAB5',
                  cancelButtonColor: '#8D9EA5',
                  confirmButtonText: '확인',
                  cancelButtonText: '취소'
				});
			}
		});
	});
};

//양식 추가
function addForm(){
   $('#addForm').click(function() {
      var mmsFormNm = $('#formNm').val().trim();
      var mmsFormCont = $('#textArea').val();
      
      var mmsFormVO = {
            "mmsFormNm":mmsFormNm,
            "mmsFormCont":mmsFormCont}
      
      $.ajax ({
         url: '/crm/addForm',
         type: 'POST',
         data: JSON.stringify(mmsFormVO),
   //       dataType: "json",
         contentType:"application/json;charset=utf-8",
         beforeSend:function(xhr){
            xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
         },
         success: function(data) {
            if(data!=null){
            	Swal.fire({
                   title: '추가 성공',
                   icon: 'success',
                   showCancelButton: false,
                   confirmButtonColor: '#0ABAB5',
                   cancelButtonColor: '#8D9EA5',
                   confirmButtonText: '확인',
                   cancelButtonText: '취소'
                }).then((result) => {
                   // 확인버튼 클릭시
                   if (result.isConfirmed) {
                          // 이전에 선택된 요소의 클래스 초기화
                          $('#formSlct option:selected').removeAttr('selected');
                          // 셀렉트의 옵션 추가
                          $('#formSlct').append(
	                      '<option data-json=\'{"cont":"' + data.mmsFormCont + '", "cd":"' + data.mmsFormCd + '"}\' selected>' 
	                      +data.mmsFormNm+
	                      '</option>');
                          // 입력창의 내용을 방금 추가한 양식의 제목과 내용으로 변경
                          formSlctChange();
                   }
               })
            }
         },
          error: function(jqXHR, textStatus, errorThrown) {
        	  Swal.fire({
                  title: '추가 실패',
                  icon: 'error',
                  showCancelButton: false,
                  confirmButtonColor: '#0ABAB5',
                  cancelButtonColor: '#8D9EA5',
                  confirmButtonText: '확인',
                  cancelButtonText: '취소'
				});
			}
		});
	});
};

//양식 수정
function updateForm(){
   $('#updateForm').click(function() {
      cont = $("#textArea").val();
      nm = $("#formNm").val();
   
      var mmsFormVO = {
            "mmsFormCd":cd,
            "mmsFormCont":cont,
            "mmsFormNm":nm}
      
      
      $.ajax ({
         url: '/crm/updateForm',
         type: 'POST',
         data: JSON.stringify(mmsFormVO),
   //       dataType: "json",
         contentType:"application/json;charset=utf-8",
         beforeSend:function(xhr){
            xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
         },
         success: function(data) {
            if(data>0){
            	Swal.fire({
                    title: '수정 성공',
                    icon: 'success',
                    showCancelButton: false,
                    confirmButtonColor: '#0ABAB5',
                    cancelButtonColor: '#8D9EA5',
                    confirmButtonText: '확인',
                    cancelButtonText: '취소'
                 }).then((result) => {
                    // 확인버튼 클릭시
                    if (result.isConfirmed) {
                   		$('#formSlct option:selected').html(nm);
                        // 입력창의 내용을 방금 수정한 양식의 제목과 내용으로 변경
                    	formSlctChange();
						}
					})
				}else{
					Swal.fire({
		                  title: '수정 실패',
		                  icon: 'error',
		                  showCancelButton: false,
		                  confirmButtonColor: '#0ABAB5',
		                  cancelButtonColor: '#8D9EA5',
		                  confirmButtonText: '확인',
		                  cancelButtonText: '취소'
						});
				}
			}
		});
	});
};

//양식 삭제
function deleteForm(){
   $('#deleteForm').click(function() {
      
      var mmsFormVO = {"mmsFormCd":cd}
      
      $.ajax ({
         url: '/crm/deleteForm',
         type: 'POST',
         data: JSON.stringify(mmsFormVO),
   //       dataType: "json",
         contentType:"application/json;charset=utf-8",
         beforeSend:function(xhr){
            xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
         },
         success: function(data) {
			if(data>0){
           		Swal.fire({
                    title: '삭제 성공',
                    icon: 'success',
                    showCancelButton: false,
                    confirmButtonColor: '#0ABAB5',
                    cancelButtonColor: '#8D9EA5',
                    confirmButtonText: '확인',
                    cancelButtonText: '취소'
                 }).then((result) => {
                    // 확인버튼 클릭시
                    if (result.isConfirmed) {
                    	 $('#formSlct option:selected').remove(); // 선택된 옵션 삭제
                         $('#formNm').val("");
                         $('#textArea').val("");
						}
					})
            }else{
            	Swal.fire({
	                  title: '삭제 실패',
	                  icon: 'error',
	                  showCancelButton: false,
	                  confirmButtonColor: '#0ABAB5',
	                  cancelButtonColor: '#8D9EA5',
	                  confirmButtonText: '확인',
	                  cancelButtonText: '취소'
					});
				}
			}
		});
	});
};
</script>
</html>