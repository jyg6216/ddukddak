<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions"%>

<style>
a {
    color: #000000 !important;
}

#calendar-container {
	width:750px;
	height:700px;
}

.fc .fc-daygrid-more-link {
	font-size: 12px !important;
}

.fc .fc-daygrid-day-number {
	font-size: 13px !important;
}

.fc-daygrid-block-event .fc-event-title {
	font-size: 12px !important;
}

.fc .fc-toolbar-title {
	font-size: 18px !important;
}

.fc .fc-toolbar.fc-header-toolbar {
    margin-bottom: 4px !important;
}

.fc .fc-button-primary {
    background-color: transparent !important;
    border-color: transparent !important;
    color: #000000 !important;
}

.fc .fc-button-primary:hover {
    background-color: transparent !important;
    border-color: transparent !important;
    color: #0ABAB5 !important;
}

.dduk-body-border {
	height: 100% !important;
}

.dduk-dir-col {
	display: flex;
    flex-direction: column;
    gap: 16px;
    width: 40%;
}

</style>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
<!-- sweetalert -->
<script src="/resources/fullcalendar-6.1.10/sweetalert2.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

<div class="dduk-body-border">
	<div class="dduk-title-area">
		<h2>월간 일정</h2>
	</div>
	<div id='calendar-container'>
	    <div id='calendar'></div>
	</div>
</div>
	
<div class="dduk-dir-col">
	<div class="dduk-body-border" style="height: 300px !important;">
		<div class="dduk-title-area" style="margin-bottom: -8px;">
			<h2 class="schedualDate">날짜를 선택해주세요</h2>
			<svg id="createPatientInput" type="button" data-bs-toggle="modal" data-bs-target="#createReservationModal"  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
				<g clip-path="url(#clip0_142_1638)">
					<path d="M18 13H13V18C13 18.55 12.55 19 12 19C11.45 19 11 18.55 11 18V13H6C5.45 13 5 12.55 5 12C5 11.45 5.45 11 6 11H11V6C11 5.45 11.45 5 12 5C12.55 5 13 5.45 13 6V11H18C18.55 11 19 11.45 19 12C19 12.55 18.55 13 18 13Z" fill="#8D9EA5"/>
				</g>
				<defs>
				<clipPath id="clip0_142_1638">
					<rect width="24" height="24" fill="white"/>
				</clipPath>
				</defs>
			</svg>
		</div>
	</div>
	<div class="dduk-body-border w-100 h-100">
		<div class="dduk-title-area" style="margin-bottom: -8px;">
			<h2 class="schedualDate">날짜를 선택해주세요</h2>
		</div>
	</div>
</div>

<script>
$(document).ready(function() {
	 var today = new Date();

	 var year = today.getFullYear();
	 var month = ('0' + (today.getMonth() + 1)).slice(-2);
	 var day = ('0' + today.getDate()).slice(-2);
	 var year2 = String(year).substring(2,4);	
	 console.log(year2);
	 
	 
	 var dateString = year + '-' + month  + '-' + day;
	 
	 var hours = ('0' + today.getHours()).slice(-2); 
	 var minutes = ('0' + today.getMinutes()).slice(-2);
	 var seconds = ('0' + today.getSeconds()).slice(-2); 

	 var timeString = hours + ':' + minutes;
	 
	 //캘린더 날짜 클릭 이벤트!!!!
	 $(document).on("click",".fc-day", function(){
		let date = $(this).data('date');
		console.log(date);
		
		let calMonth = date.substring(5,7);
		console.log(calMonth);
		let calDay = date.substring(8,10);
		console.log(calDay);
		
		$('.schedualDate').html("");
		$('.schedualDate').append(calMonth+"월 "+calDay+"일, ");
		
	 });
	
})


// 달력 자리 지정
const calendarEl = $('#calendar')[0];
// 현재 날짜 불러와서 문자 형태 맞추기
const date = new Date();
const year = date.getFullYear();

document.addEventListener('DOMContentLoaded', function() {
	// 달력 세부 설정
	const calendar = new FullCalendar.Calendar(calendarEl, {
		// 한국어 설정
		locale : 'ko',
		height: '700px',
		// 화면에 맞게 높이 재설정
		expandRows : true,
		// 이벤트가 오버되면 높이 제한 (+ 몇 개식으로 표현)
		dayMaxEvents: true,
		// 초기 로드 될때 보이는 캘린더 화면(기본 설정: 달)
		initialView : 'dayGridMonth',
		// 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크
		navLinks : false,
		// +more 표시 전 최대 이벤트 갯수, true는 셀 높이에 의해 결정
		dayMaxEvents: true,
		// 버튼 만들기
		customButtons : {
			calButton : {
				text : "캘린더",
				click : function() {
					calendar.refetchEvents();
				}
			}
		},
		// 해더에 표시할 툴바
		headerToolbar : {
			left : 'calButton prev,next',
			center : 'title',
			right : 'dayGridMonth'
		},
		
	});
	// 달력 띄우기
	calendar.render();
	
	// 달력 DB 로딩
	let listData = { year : year };
	
	$.ajax({
		url:"/reserve/schList",
		type:"post",
		data: listData,
		dataType: "JSON",
		async: false,
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success : function(data, status, xhr){
			$.each(data, function(key, value){
				// DB에서 가져온 일정 리스트 배치
				dsNo = data[key].dsNo;
				start = data[key].dsStrDate;
				end = data[key].dsEndDate;
				content = data[key].dsCont;
				dbCate = data[key].dsCate; // if => color
					if(dbCate === '진료'){
						color = "#0ABAB5";
					}else if(dbCate === '수술'){
						color = "#cce6ff";
					}else if(dbCate === '검사'){
						color = "#d9ccff";
					}else if(dbCate === '연구'){
						color = "#DBF2F4";
					}else{
						color = "#ffcccc";
					}  
				isAllDay = data[key].dsAd; // if => allDay
				
				let eventData = {
				    start: start,
				    end: end,
				    title: content,
				    color: color,
				    allDay: isAllDay,
				    id : dsNo,
				    groupId : dbCate,
				};
				
				// month 달력에 이벤트 출력
				calendar.addEvent(eventData);
				calendar.render();
			});
			
		}, error : function(xhr, status, error){
		  Swal.fire({
			   	title: '데이터 로딩 실패',
			   	text: '새로고침 해주세요.',
			   	icon: 'error',
			   	confirmButtonColor: '#0ABAB5',
			   	confirmButtonText: '확인',
			})
			return;
	  }
	});
})


</script>