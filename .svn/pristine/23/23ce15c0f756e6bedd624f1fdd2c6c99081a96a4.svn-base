<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<script type="text/javascript" src="/resources/js/jquery-3.6.0.js"></script>
<script type="text/javascript">
$(function() {
		// 이미지 미리보기 시작
		$("#uploadFile").on("change", fileSelected);
		
		function fileSelected(e) { 
			let files = e.target.files;
			// 이미지 오브젝트 배열
			let fileArr = Array.prototype.slice.call(files);
			fileArr.forEach(function(f){
				if(!f.type.match("image.*")){
					alert("이미지만 가능합니다.");
					return;
				}
				
				let reader = new FileReader();
				reader.onload = function(e){
					console.log(e.target.result);
					$("#atchFileCd").attr("src", e.target.result);
				}
				reader.readAsDataURL(f);
			});
		}
		// 이미지 미리보기 끝 
		
		// 수정 버튼 클릭 전 수정 막아놓기
		$(".form-control").attr("readonly","readonly");
		
		// 수정모드 전환
		$("#edit").on("click",function(){
			//id속성의 값이 spn1인 요소를 보이지 않도록 하고
			$("#spn1").css("display","none");		
			//id속성의 값이 spn2인 요소를 보이도록 하자
			$("#spn2").css("display","block");
			//클래스 값이 form-control-user인 요소를 선택하여 disabled속성을 제거하자
			$(".form-control").removeAttr("readonly");
			//id속성의 값이 frm인 요소(form태그)의 action속성의 값을 /business/updatePost로 바꾸자
			$("#frm").attr("action","/emp/update");
		});
		
		// 삭제
		$("#delete").on("click",function(){
			$("#frm").attr("action","/common/login");
			// 삭제 확인
			Swal.fire({
				title: '삭제하시겠습니까?',
				icon: 'question',
				showCancelButton: true,
				confirmButtonColor: '#0ABAB5',
				cancelButtonColor: '#8D9EA5',
				confirmButtonText: '확인',
				cancelButtonText: '취소'
			}).then((result) => {
				if (result.isConfirmed) {
				// 확인버튼 클릭시
				  Swal.fire("Saved!", "", "success");
				  $("#frm").submit();
				} else if (result.isDenied) {
				  Swal.fire("삭제가 취소되었습니다.", "", "info");
				}
			})
		});
});
</script>
<script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>
<script src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"></script>
<style>
.dduk-login-input {
	width: 320px;
	height: 40px;
	flex-shrink: 0;
}

.dduk-login-d{
	gap: 16px;
}

.dduk-row {
	display: flex;
    gap: 24px;
}

.join-btn {
	display: flex;
	width: 100px;
	padding: 8px 16px;
	justify-content: center;
	align-items: center;
	gap: 4px;
	border-radius: 12px;
	background: var(--black-02, #64767C);
}

.join-btn:hover{
	background: var(--black-01, #323537);
}

.toMain {
	width:100%;
	background: var(--ci-01, #0ABAB5);
}

#spn2 {
	margin : 30px 50px;
}

.search-btn {
	margin-left:8px; 
	padding: 4px 14px; 
	border-radius: 12px; 
	height: 38px;
}

.btn-group {
	width: 100%;
	gap: 8px;
}

.btn-outline{
	border: 1px soild var(--black-01, #333);
}

input[type=file]::file-selector-button {
  display: flex;
	padding: 5px 10px;
	align-items: center;
	gap: 10px;
	border-radius: 8px;
	border: 1px solid var(--ci-01, #0ABAB5);
	background: var(--ci-01, #0ABAB5);
	color: var(--white, #FFF);
	font-family: 'Pretendard5';
	font-style: normal;
	line-height: 160%; /* 22.4px */
	border: 0px;
	justify-content: center !important;
}

 input[type=file]::file-selector-button:hover {
    background: #0ABAB5;
 }
 
 #uploadFile {
  display: none;
}

.form-check {
	display: flex;
    gap: 40px;
    padding: 8px 16px;
    margin-top: 8px;
    margin-left: 16px;
}

.img-circle{
	width: 300px;
	height: 300px;
	border-radius: 50%;
	margin: 16px;
	object-fit: cover;
}

#camIcon {
	position: absolute;
	margin-left:-175px;
	width : 30px;
	height : 30px;
}

.form-check-input:checked {
	background-color: var(--ci-01, #0ABAB5);
	border-color: var(--ci-01, #0ABAB5);
}

h1{
	margin-top: 20px;
}

.button-margin {
	margin-left: 8px;
}
.per-info {
	display:inline-block;
	width: 300px;
	height: 50px;
	margin: 30px 15px;
	text-align: center;
}

</style>
<div class="dduk-body-border" style="width:120vh; height: 100%; ">
	<form name="frm" class="d-flex"
			action="/emp/update?${_csrf.parameterName}=${_csrf.token}"
			method="post" enctype="multipart/form-data">
				<div class="d-flex mar-b-16" style=" justify-content:space-between; gap: 24px;">
<!-- 					<div> -->
<!-- 						<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"> -->
<!-- 							<g clip-path="url(#clip0_82_1936)"> -->
<!-- 							<path d="M19 11H7.82998L12.71 6.11997C13.1 5.72997 13.1 5.08997 12.71 4.69997C12.32 4.30997 11.69 4.30997 11.3 4.69997L4.70998 11.29C4.31998 11.68 4.31998 12.31 4.70998 12.7L11.3 19.29C11.69 19.68 12.32 19.68 12.71 19.29C13.1 18.9 13.1 18.27 12.71 17.88L7.82998 13H19C19.55 13 20 12.55 20 12C20 11.45 19.55 11 19 11Z" fill="#333333"/> -->
<!-- 							</g> -->
<!-- 							<defs> -->
<%-- 							<clipPath id="clip0_82_1936"> --%>
<!-- 							<rect width="24" height="24" fill="white"/> -->
<%-- 							</clipPath> --%>
<!-- 							</defs> -->
<!-- 						</svg> -->
<!-- 					</div> -->
				</div>
				<div style="margin-left: 100px; float:left;">
					<div class="dduk-row">
						<div>
							<div class="d-flex" style="align-items: center;">
								<img class="img-circle"
									src="/resources/upload/${employeeVO.atchFileVO.atchFileDetailVOList[0].atchFileDetailSavenm}"
									alt="User profile picture" id="atchFileCd">
								<div class="custom-file" style="position: absolute; margin-left: 500px;">
									<label for="uploadFile">
										<svg id="camIcon" xmlns="http://www.w3.org/2000/svg"><path d="M0 6c0-1.1.9-2 2-2h3l2-2h6l2 2h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6zm10 10a5 5 0 1 0 0-10 5 5 0 0 0 0 10zm0-2a3 3 0 1 1 0-6 3 3 0 0 1 0 6z" fill="#8d9ea5" class="fill-000000"></path></svg>
									</label>
									<input type="file" class="dduk-login-input" name="uploadFile" id="uploadFile" /> 
								</div>
							</div>
						</div>
					</div>
					<div class="per-info">
							<div class="dduk-login-d">
								<div id="empDeptCd" name="empDeptCd" class="" type="text" style="display:inline-block;">
									<!-- /detailCodeAjax => 직책 -->
								</div>
								•
								<div id="empJbpsCd" name="empJbpsCd" class="" type="text" style="display:inline-block;">
									<!-- /detailCodeAjax => 직책 -->
								</div>
							</div>
							<div class="dduk-login-d">
								<div class="login-input-label">${employeeVO.empName}</div>
							</div>
							<div class="dduk-login-d">
								<div class="login-input-label">${employeeVO.empNo}</div> 
							</div>
					</div>
					<!-- 일반모드 시작 -->
					<span id="spn1">
					<p style="margin-top:50px;">
						<button type="button" id="edit" class="join-btn" style="width:50%; float:left;">수정</button>
						<button type="button" id="delete" class="join-btn" style="width:50%;">삭제</button>
					</p>
					<p>
						<button type="button" onclick="location.href='/common/main'" class="join-btn toMain" >
							메인으로
						</button>
					</p>
					</span>
					<!-- 일반모드 끝 -->
					<!-- 수정모드 시작 -->
					<span id="spn2" style="display:none;">
						<p style="display:inline-block;" >
							<button type="submit" class="join-btn" style="width:100px; float:left;">
								저장
							</button>
						</p>
						<p style="display:inline-block;">
							<button type="button" onclick="location.href='/emp/detail?empNo=${employeeVO.empNo}'" class="join-btn" style="width:100px; float:left;">
								취소
							</button>
						</p>
					</span>
					<!-- 수정모드 끝 -->		
				</div>

				<div class="dduk-row" style=" margin-left: 100px; float:left;">
					<div class="login-form-content">
						<div class="dduk-login-d">
							<div class="login-input-label">비밀번호</div>
							<input id="empPw" name="empPw" class="form-control dduk-login-input" type="password"
							value="********" />
						</div>
						<div class="dduk-login-d">
							<div class="login-input-label ">비밀번호 확인</div>
							<input id="pwConfirm" name="pwConfirm" class="form-control dduk-login-input" type="password" placeholder="비밀번호 확인" />
						</div>
								
						<div class="dduk-login" style="margin: 12px 0px;">
							<div class="dduk-login-d" style="margin-bottom: 0px;">
								<div class="login-input-label">주소</div>
								<div class="d-flex" style="align-items: baseline">
									<input type="hidden" name="empNo" value="${employeeVO.empNo}">
									<input type="text" id="empZip" name="empZip" class="form-control dduk-login-input" style="width: 203px;"
								value="${employeeVO.empZip}"  />
									<button type="button" class="dduk-btn-nomal search-btn" id="btnPost" >우편번호 찾기</button>
								</div>
									
							</div>
							<div class="dduk-login-d" style="margin-bottom: 0px;">
								<input id="empAdd1" name="empAdd1" value="${employeeVO.empAdd1}" class="form-control dduk-login-input" type="text" />
							</div>
							<div class="dduk-login-d">
								<input id="empAdd2" name="empAdd2" value="${employeeVO.empAdd2}" class="form-control dduk-login-input" type="text" />
							</div>
						</div>
						
						<div class="dduk-login-d">
							<div class="login-input-label form-control-user">연락처</div> 
							<input id="empPh" name="empPh" class="form-control dduk-login-input" type="text"
							value="${employeeVO.empPh}" />
						</div>
						<div class="dduk-login-d">
							<div class="login-input-label form-control-user">이메일</div> 
							<input id="empMail" name="empMail" class="form-control dduk-login-input" type="text"
							value="${employeeVO.empMail}" />
						</div>
						
						<div class="dduk-login-d">
							<div class="login-input-label form-control-user">주민번호</div> 
							<input id="empReg" name="empReg" class="form-control dduk-login-input" type="text"
								value="${employeeVO.empReg}" />
						</div>
						
						
					</div>
				</div>
			<sec:csrfInput />
		</form>
</div>
<script type="text/javascript">
$(function(){
	// 직무 코드 확인해서 이름으로 출력
	const empDeptCd = "${employeeVO.empDeptCd}";
	console.log(empDeptCd);
	let deptTemp = $("#empDeptCd");
	
	if(empDeptCd == 'DTCD01'){
		var temp_html ='<div>의사</div>';
		deptTemp.append(temp_html);
	} else if (empDeptCd == 'DTCD02'){
		var temp_html ='<div>간호사</div>';
		deptTemp.append(temp_html);
	} else if (empDeptCd == 'DTCD03'){
		var temp_html ='<div>치료사</div>';
		deptTemp.append(temp_html);
	} else if (empDeptCd == 'DTCD04'){
		var temp_html ='<div>원무과</div>';
		deptTemp.append(temp_html);
	} else {
		var temp_html ='<div>인사과</div>';
		deptTemp.append(temp_html);
	}
	
	// 직책 코드 확인해서 이름으로 가져오기
    const empJbpsCd = "${employeeVO.empJbpsCd}";
    console.log("empJbpsCd : ",empJbpsCd);
    let temp = $("#empJbpsCd");
    
    let data = {
    		"empJbpsCd" : empJbpsCd
    };
    
    $.ajax({
    	url:"/comcode/detailCodeAjax",
    	contentType:"application/json;charset=utf-8",
		data:JSON.stringify(data),
		type:"post",
		dataType:"json",
		beforeSend:function(xhr){
			xhr.setRequestHeader("${_csrf.headerName}","${_csrf.token}");
		},
		success:function(result){
			console.log("result",result[0]);
			
			let temp_html = '';
            temp_html +='<div>'+result[0].comDetCodeNm+'</div>';
            temp.append(temp_html);
		}
    });
	
	// 다음 우편 번호 검색
	$("#btnPost").on("click", function(){
		new daum.Postcode({
		//다음 창에서 검색이 완료되면 콜백함수에 의해 결과 데이터가 data 객체로 들어옴
			oncomplete:function(data){
				$("#empZip").val(data.zonecode);
				$("#empAdd1").val(data.address);
				$("#empAdd2").val(data.buildingName);
			}
		}).open();
	});
    
	// 비밀번호 확인
    let pw = $("#empPw");
	let pwCf = $("#pwConfirm");
    
	// 확인란 입력되면 비밀번호와 일치하는지 검사
	pwCf.on("change", function(){
		if(pw.val() != pwCf.val()) {
	        Swal.fire({
		    	title: '비밀번호가 일치하지 않습니다.',
		    	text: '문제가 계속된다면 관리자에게 문의하세요',
		    	icon: 'error',
		    	confirmButtonColor: '#0ABAB5',
		    	confirmButtonText: '확인',
			})
	        
			// 비밀번호가 일치하지 않으면 내용을 비워줌
			pw.val("");
	        pwCf.val("");
			
	        return false;
	    } 
	})
	
})
</script>